## 1. Архитектура и модульность
- **Каждый модуль обязан иметь единую ответственность** (SRP).  
  Файл > 400 LOC или функция > 30 LOC считается code-smell — разбивай.
- Храни Telegram-логики в `bot/handlers/`, работу с БД — в `bot/db/`, вспомогательные утилиты — в `bot/utils/`.  
  Никогда не смешивай SQL-запросы с обработчиками сообщений.

## 2. Асинхронность и стек
- Пиши только на **Python 3.12+** c **aiogram 3.x**; всегда используй `async def` и `await`.
- Для БД применяй **SQLite** + `aiosqlite` *только* с параметризованными запросами (`?`) — никаких строковых конкатенаций.

## 3. Стиль и качество
- Код должен проходить **black** (120 cols) и **ruff** без ошибок.  
- Следуй **PEP8** и используй **type hints**; для структур данных — `@dataclass`.
- Все public-функции и классы снабжай **docstring** формата *Google-style*.

## 4. Test-Driven & TODO-Driven Development
1. **Перед** реализацией новой логики добавь/обнови unit-тесты (`tests/`) с `pytest` и `pytest-asyncio`; тест должен _падать_.  
2. Напиши минимальный код, чтобы тест **зеленел**; рефакторь, сохраняя зелёные тесты.  
3. Каждый `TODO:` в коде обязан ссылаться на номер issue и сопровождаться **тестом, воспроизводящим ожидание**.  
   Удаляй `TODO`, как только задача выполнена и тесты зелёные.  
4. Покрытие кода (`pytest --cov`) минимум **80 %** для `bot/`.  

## 5. Безопасность и конфиденциальность
- Никаких токенов, паролей и SQL-дампов в репозитории.  
  Читай их из `ENV` через `python-dotenv`; для секретов используй `.env.example`.
- Запрещено использовать `eval`, `exec`, небезопасные «сырые» SQL.  
- Всегда валидируй пользовательский ввод: суммы должны быть `int` ≥ 0; `username` — RegExp `^@[A-Za-z0-9_]{5,}$`.

## 6. Логирование
- Используй встроенный модуль `logging`; **никаких `print()`**.  
  Формат по умолчанию — `%(asctime)s %(levelname)s [%(name)s] %(message)s`.

## 7. Контекст вызова AI-ассистента
- Если для решения запроса нужен файл, **включи его через `@file`** (Cursor `@-syntax`).  
- Перед любым автоматическим правлением файлов:
  1. Найди релевантные тесты (`@tests/…`) и включи их в контекст.  
  2. Спроси пользователя, если спецификация неочевидна.

## 8. Коммиты и PR-ы
- Соблюдай **Conventional Commits** (`feat:`, `fix:`, `refactor:` …).  
- На каждый PR — CI-прогоны: форматтер, линтер, тесты.

## 9. Ограничения генерации
- **Никогда** не генерируй большие блоки без тестов.  
- Если задача требует UI-кода или SQL-миграции, создай отдельные PR-файлы в `migrations/` или `bot/ui/`, а затем обнови тесты.

## 10. Документация
- Обновляй `README.md` и `docs/` при изменении публичного API или команд бота.  
- Храни схемы БД в `docs/schema.sql` и генерируй диаграмму ERD при крупных изменениях.

> Нарушение любого пункта считается ошибкой CI; генерация, не соответствующая правилам, должна быть отклонена или отредактирована.
